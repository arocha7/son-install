
- name: add Docker common release to YUM list of repositories
  copy: src=virt7-docker-common-release.repo dest=/etc/yum.repos.d/virt7-docker-common-release.repo owner=root group=root mode=0644

- name: Install Kubernetes, etcd and flannel
  yum: name={{ item }} state=present update_cache=yes enablerepo=virt7-docker-common-release
  with_items:
  - kubernetes
  - etcd
  - flannel

- name: set Kube Master configuration
  copy: src=kube.conf dest=/etc/kubernetes/config owner=root group=root mode=0644

- command: setenforce 0
- command: systemctl disable iptables-services firewalld
- command: systemctl stop iptables-services firewalld

- name: set Kube ETDC configuration
  copy: src=etcd.conf dest=/etc/etcd/etcd.conf owner=root group=root mode=0644

- name: set Kube API Server configuration
  copy: src=apiserver dest=/etc/kubernetes/apiserver owner=root group=root mode=0644

- command: systemctl start etcd
- command: etcdctl mkdir /k8s/network
- command: etcdctl mk /k8s/network/config "{ \"Network\": \"172.30.0.0/16\", \"SubnetLen\": 24, \"Backend\": { \"Type\": \"vxlan\" } }"

- name: set Kube FLANNELD configuration
  copy: src=flanneld dest=/etc/sysconfig/flanneld owner=root group=root mode=0644

- name: starting Kube Master services
  service: name={{ item }} state=started enabled=true
  with_items:
  - etcd
  - kube-apiserver
  - kube-controller-manager
  - kube-scheduler
  - flanneld
