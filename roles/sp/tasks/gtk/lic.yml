---
# Populate pgSQL database LIC
- name: create data model and populate db
  shell: /usr/bin/docker run --name son-gtklic --net={{ docker_network_name }} --network-alias=son-gtklic -i -e DATABASE_HOST=son-postgres -e DATABASE_PORT=5432 -e POSTGRES_PASSWORD=sonata -e POSTGRES_USER=sonatatest -e POSTGRES_DB=gatekeeper --rm=true sonatanfv/son-gtklic:{{ ver }} python manage.py db upgrade

# Running the Sonata GK SERVICES (Docker container)
- name: GATEKEEPER LICENSE MANAGER (GTKLIC) (Docker container)
  docker_container:
    name: son-gtklic
    image: "sonatanfv/son-gtklic:{{ ver }}"
    env:
      DATABASE_HOST: son-postgres
      DATABASE_PORT: 5432
      POSTGRES_PASSWORD: sonata
      POSTGRES_USER: sonatatest
      POSTGRES_DB: gatekeeper
    state: started
    restart_policy: "unless-stopped"
    network_mode: bridge
    networks:
      - name: "{{ docker_network_name }}"
        aliases:
          - son-gtklic
    exposed_ports: 5900
    published_ports: "5900:5900"

- wait_for: host=0.0.0.0 port=5900 timeout=300 delay=10 state=started

