---
# Populate pgSQL database SRV
- name: create data model and populate db
  shell: /usr/bin/docker run -i --net={{ docker_network_name }} -e DATABASE_HOST={{ public_ip }} -e MQSERVER=amqp://guest:guest@{{ public_ip }}:5672 -e RACK_ENV=integration -e CATALOGUES_URL=http://{{ public_ip }}:4002/catalogues/api/v2 -e DATABASE_HOST={{ public_ip }} -e DATABASE_PORT=5432 -e POSTGRES_PASSWORD=sonata -e POSTGRES_USER=sonatatest --rm=true sonatanfv/son-gtksrv:{{ ver }} bundle exec rake db:migrate

# Running the Sonata GK SERVICES (Docker container)
- name: GATEKEEPER SERVICES - running Docker containers
  docker_container:
    name: son-gtksrv
    image: "sonatanfv/son-gtksrv:{{ ver }}"
    env:
      CATALOGUES_URL: http://{{ public_ip }}:4002/catalogues/api/v2
      RACK_ENV: integration
      MQSERVER: amqp://guest:guest@{{ public_ip }}:5672
      DATABASE_HOST: "{{ public_ip }}"
      DATABASE_PORT: 5432
      POSTGRES_PASSWORD: sonata
      POSTGRES_USER: sonatatest
    network_mode: bridge
    networks:
      - name: "{{ docker_network_name }}"
        aliases:
          - son-gtksrv
    state: started
    restart_policy: "unless-stopped"
    published_ports: "5300:5300"
    log_driver: syslog

- wait_for: host=0.0.0.0 port=5300 timeout=30 delay=10 state=started
