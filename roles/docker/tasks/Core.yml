---

####

- name: create Docker group
  group:
    name: docker
    state: present
  become: true

- name: set default username
  set_fact:
    vm_user: centos

- name: add Docker group to default user
  user:
    name: "{{ vm_user }}"
    shell: /bin/bash
    groups: docker
    append: yes
  become: true

- name: create a directory for Docker logging
  file:
    path: /var/log/docker
    state: directory
    owner: '{{ vm_user }}'
    group: docker
    mode: 0775
  become: true

####

- name: uninstall previous Docker releases
  yum: name="{{ item }}" state=absent update_cache=yes
  with_items: 
    - docker-client
    - docker-client-latest
    - docker-common
    - docker-latest
    - docker-latest-logrotate
    - docker-logrotate
    - docker-selinux
    - docker-engine-selinux
    - docker-engine
    - docker-python
  ignore_errors: yes

###

- name: upgrade all packages
  yum:
    name: '*'
    state: latest

- name: install EPEL
  yum:
    name: epel-release
    state: present

- name: install PIP
  yum:
    name: python-pip
    state: present

- name: upgrade PIP
  pip:
    name: pip
    extra_args: --upgrade
    state: present
    version: 10.0.1

- name: uninstall 'docker' (v1.10.6)
  pip: name=docker-py state=absent

####

- name: install 'docker' (v3.4.x)
  pip: name=docker state=present

- name: install required packages 
  yum: name="{{ item }}"
  with_items:
    - device-mapper-persistent-data
    - lvm2

- yum: name=epel-release state=latest

#- name: add Docker repo to YUM
#  copy: src=docker.repo dest=/etc/yum.repos.d/docker.repo owner=root group=root mode=0644

- name: Import Docker CE repository gpg key
  rpm_key:
    key: https://download.docker.com/linux/centos/gpg
    #id: 060A61C51B558A7F742B77AAC52FEB6B621E9F35
    state: present

- name: set up the stable repository
  yum_repository:
    name: docker-ce
    description: Docker CE repo
    file: docker-ce
    baseurl: https://download.docker.com/linux/centos/$releasever/x86_64/stable/
    enabled: yes
    gpgcheck: yes
    state: present

- name: install Docker on CentOS7
  yum: name=docker-ce state=present update_cache=yes

- name: start Docker engine
  systemd:
    name: docker
    state: started
    daemon_reload: yes
    enabled: yes
  become: true

#- name: add Docker configuration options
#  copy: src=docker2systemd dest=/etc/sysconfig/docker owner=root group=root mode=0644

#- name: create a directory if it doesn't exist
#  file: path=/etc/systemd/system/docker.service.d/ state=directory mode=0755

#- name: configuring Docker options
#  copy: src=docker.conf dest=/etc/systemd/system/docker.service.d/docker.conf owner=root group=root mode=0644
#  register: result
