---

- name: uninstall previous Docker releases
  yum: name="{{ item }}" state=absent update_cache=yes
  with_items: 
    - docker-client
    - docker-client-latest
    - docker-common
    - docker-latest
    - docker-latest-logrotate
    - docker-logrotate
    - docker-selinux
    - docker-engine-selinux
    - docker-engine
    - docker-python
  ignore_errors: yes


### INSTALL REQUIRED LIBRARIES

- name: upgrade all packages
  yum:
    name: '*'
    state: latest
    update_cache: yes

- name: install EPEL
  yum:
    name: epel-release
    state: latest

- name: install PIP
  yum:
    name: python-pip
    state: latest

- name: upgrade PIP
  pip:
    name: pip
    extra_args: --upgrade
    state: present
    #version: 18.0


#### CREATE USER AND GROUP

- name: create Docker group
  group:
    name: docker
    state: present

- name: set default username
  set_fact:
    vm_user: centos

- name: add Docker group to default user
  user:
    name: "{{ vm_user }}"
    shell: /bin/bash
    groups: docker
    append: yes

- name: create a directory for Docker logging
  file:
    path: /var/log/docker
    state: directory
    owner: '{{ vm_user }}'
    group: docker
    mode: 0775


#### INSTALL LATEST STABLE RELEASE

- name: install required packages 
  yum: name="{{ item }}"
  with_items:
    - device-mapper-persistent-data
    - lvm2

#- name: install Docker (v3.4.x)
#  pip:
#    name: docker
#    state: latest

- name: install 'docker-py'
  pip:
    name: docker-py
    state: present

- name: Import Docker CE repository gpg key
  rpm_key:
    key: https://download.docker.com/linux/centos/gpg
    #id: 060A61C51B558A7F742B77AAC52FEB6B621E9F35
    state: present

- name: set up the stable repository
  yum_repository:
    name: docker-ce
    description: Docker CE repo
    file: docker-ce
    baseurl: https://download.docker.com/linux/centos/$releasever/x86_64/stable/
    enabled: yes
    gpgcheck: yes
    state: present

- name: install Docker on CentOS7
  yum: name=docker-ce state=present update_cache=yes

### https://lonelycoding.com/how-to-get-remote-access-to-a-private-docker-registry/

- name: create a directory for Docker reconfiguration file
  file:
    path: "/etc/systemd/system/docker.service.d"
    state: directory
    owner: root
    group: root
    mode: 0755

- name: override Docker config to support Insecure Registry
  copy:
    src: docker.service_ce7
    dest: "/etc/systemd/system/docker.service.d/override.conf"
    owner: root
    group: root
    mode: 0644

- name: get access to a remote private Docker Registry
  lineinfile:
    dest: "/etc/systemd/system/docker.service.d/override.conf"
    regexp: "^ExecStart=/usr/bin/dockerd"
    line: "ExecStart=/usr/bin/dockerd -H tcp://0.0.0.0:2375 -H unix:///var/run/docker.sock --insecure-registry registry.sonata-nfv.eu:5000"
    state: "present"

- name: start Docker engine
  systemd:
    name: docker
    state: started
    daemon_reload: yes
    enabled: yes

