- debug: msg="##### INSTALLING OpenVPN {{ lookup('pipe', 'date +%Y%m%d-%H:%M:%S') }}"

- name: previous install APTitude
  apt: name=aptitude state=present

- name: upgrade all packages to the latest version
  apt: upgrade=yes update_cache=yes

## INSTALL

- name: install OpenVPN and tools
  apt: name={{ item }} state=latest
  with_items:
    - openvpn
    - easy-rsa

## SETUP

- name: setup 'vars' for CA
  copy:
    #src: "{{ lookup('env','PWD') }}/roles/openvpn/files/vars"
    src: "vars"
    dest: /usr/share/easy-rsa/

- name: setup the CA directory
  shell: make-cadir "{{ lookup('env','HOME') }}/openvpnca"

- name: build the CA
  block:
    - name: source 'vars'
      shell: source vars
    - name: make sure we are operating a clean environment
      shell: ./clean-all
    - name: build our own CA
      shell: ./build-ca

- name: Create the Server Certificate, Key, and Encryption Files
  block:
    - name: install 'pexpect'
      pip:
        name: pexpect
        state: present
    - name: generating the OpenVPN server certificate and key pair
      expect:
        command: './build-key-server server'
        responses:
          Question:
            - y
            - y
        echo: yes
    - name: generate a strong Diffie-Hellman keys
      shell: ./build-dh
    - name: generate an HMAC signature to strengthen the server's TLS integrity verification capabilities
      shell: openvpn --genkey --secret keys/ta.key

- name: Generate a Client Certificate and Key Pair
  block:
    - name: source 'vars'
      shell: 'source vars'
    - name: build our own CA
      shell: './build-key clnt01'
 
## CONFIG

- name: Copy the generated files to the OpenVPN Directory
  block:
    - copy:
        src: "{{ lookup('env','HOME') }}/openvpn-ca/keys/{{ item }}"
        dest: /etc/openvpn
        remote_src: yes
      with_fileglob:
        - ca.crt
        - server.crt
        - server.key
        - ta.key
        - dh2048.pem
    - file:
        path: /etc/openvpn
        state: directory
        mode: 0755
    - unarchive:
        src: /usr/share/doc/openvpn/examples/sample-config-files/server.conf.gz
        dest: /etc/openvpn
        remote_src: yes
    
- name: open firewall ports
  block:
  - ufw:
      rule: allow
      port: '1194/udp'
  - ufw:
      rule: allow
      name: 'OpenSSH'

## START

- name: Start and Enable the OpenVPN Service
  systemd:
    name: openvpn@server
    state: started
    enabled: true
    daemon_reload: yes

