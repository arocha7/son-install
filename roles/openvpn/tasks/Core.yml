- debug: msg="##### Starting OpenVPN deployment {{ lookup('pipe', 'date +%Y%m%d-%H:%M:%S') }}"

## INSTALL

- name:  upgrade all packages to the latest version
  yum: name='*' state=latest update_cache=yes

- yum: name=epel-release state=latest

- name: install OpenVPN
  yum: name=openvpn state=present

- unarchive:
    src: 'https://github.com/OpenVPN/easy-rsa-old/archive/2.3.3.tar.gz'
    dest: /tmp
    remote_src: yes

- file:
    path: /etc/openvpn/easy-rsa
    state: directory
    mode: 0755

- copy:
    src: "{{ item }}"
    dest: /etc/openvpn/easy-rsa
    remote_src: yes
  with_fileglob:
    - /tmp/easy-rsa-old-2.3.3/easy-rsa/2.0/*

- shell: 'chown -R {{ vm_user }} /etc/openvpn/easy-rsa/'

## CONFIG

- name: Configuring OpenVPN
  copy:
    src: "{{ lookup('env','PWD') }}/roles/openvpn/files/server.conf"
    dest: /etc/openvpn
    owner: root
    group: root
    mode: 0644

- shell: 'openvpn --genkey --secret /etc/openvpn/myvpn.tlsauth'

- name: Generating Keys and Certificates
  file:
    path: '/etc/openvpn/easy-rsa/keys'
    state: directory
    mode: 0755
- copy:
    src: '{{ lookup("env","PWD") }}/roles/openvpn/files/vars'
    dest: '/etc/openvpn/easy-rsa'

- include_tasks: build-ca.yml

- include_tasks: build-ca-client.yml

- copy:
    src: /etc/openvpn/easy-rsa/openssl-1.0.0.cnf
    dest: /etc/openvpn/easy-rsa/openssl.cnf
    remote_src: yes

- name: open firewall ports
  block:
  - firewalld:
      service: OpenSSH
      permanent: true
      state: enabled
  - firewalld:
      port: 1143/udp
      permanent: true
      state: enabled
  - systemd:
      name: firewalld
      state: restarted
      daemon_reload: yes

- name: enable IP Forwarding
  sysctl:
    name: net.ipv4.ip_forward
    value: 1
    sysctl_set: yes
    state: present
    reload: yes
  notify: restart network

